name: commit
on: [push]
jobs:
  go-build:
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v4
      - uses: actions/setup-go@v5
        with:
          go-version: 1.23
      - uses: goreleaser/goreleaser-action@v6
        with:
          distribution: goreleaser
          version: '~> v2.6'
          install-only: true
      - run: go version
      - run: goreleaser release --clean --snapshot
  go-lint:
    needs: go-build
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v4
      - uses: actions/setup-go@v5
        with:
          go-version: 1.23
      - uses: golangci/golangci-lint-action@v6
        with:
          version: v1.63.4
  go-test:
    needs: go-build
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v4
      - uses: actions/setup-go@v5
        with:
          go-version: 1.23
      - run: go version
      - run: make cassandra-up
      - run: go test ./...
  commit-message-lint:
    runs-on: ubuntu-latest
    steps:
      - run: npm install -g @commitlint/cli @commitlint/config-conventional
      - run: |
          echo "export default { extends: ['@commitlint/config-conventional'] };" > commitlint.config.js
          echo '{ "type": "module" }' > package.json
      - run: npx commitlint --from ${{ github.event.pull_request.head.sha }}~${{ github.event.pull_request.commits }} --to ${{ github.event.pull_request.head.sha }} --verbose
